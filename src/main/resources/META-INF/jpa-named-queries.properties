# suppress inspection "UnusedProperty" for whole file
#
# Find all available rooms of a certain type for a given period of time
#
Room.findAvailableRooms=\
    FROM Room rm \
    WHERE rm.type.id = :typeId \
    AND rm.id NOT IN ( \
        SELECT distinct r.room.id \
        FROM Reservation r \
        WHERE \
            r.room.type.id = :typeId \
        AND ( \
            r.checkIn <= :arrivalDate   AND r.checkOut >  :arrivalDate   OR \
            r.checkIn <  :departureDate AND r.checkOut >= :departureDate OR \
            r.checkIn <= :arrivalDate   AND r.checkOut >= :departureDate OR \
            r.checkIn >  :arrivalDate   AND r.checkOut <  :departureDate \
            ) \
    ) \
    ORDER BY rm.number ASC
#
# Calculate available rooms count by room types for a given period of time.
# Returns list of available room types with number of free rooms for the given period.
#
RoomType.getAvailability=\
  SELECT new lv.id.jc.hotel.model.dto.AvailabilityResponse(\
        types.id, \
        types.name, \
        count(rooms)) \
  FROM Room AS rooms \
  JOIN rooms.type AS types \
  WHERE rooms.id NOT IN (\
        SELECT distinct r.room.id \
        FROM Reservation r \
        WHERE \
            r.checkIn <= :arrivalDate   AND r.checkOut >  :arrivalDate   OR \
            r.checkIn <  :departureDate AND r.checkOut >= :departureDate OR \
            r.checkIn <= :arrivalDate   AND r.checkOut >= :departureDate OR \
            r.checkIn >  :arrivalDate   AND r.checkOut <  :departureDate \
        ) \
  GROUP BY types \
  ORDER BY types.id
#
#
#
Room.getSchedule=\
  WITH DATE_RANGE AS (\
        SELECT DATEADD(DAY, X, :startDate) AS CDATE \
        FROM SYSTEM_RANGE(0, DATEDIFF(DAY, :startDate, :endDate)) \
    ), booking AS ( \
        SELECT CDATE, ( \
            SELECT ID \
            FROM RESERVATION \
            WHERE ROOM_ID = :roomId \
            AND CHECK_IN <= CDATE \
            AND CHECK_OUT > CDATE) AS book_id \
        FROM DATE_RANGE \
    ), schedule AS ( \
        SELECT CDATE, book_id, guest_id \
        FROM booking \
        LEFT JOIN RESERVATION on book_id = RESERVATION.id \
    ) \
  SELECT cdate as date, book_id as bookId, guest_id as guestId, name, email \
    FROM schedule \
    LEFT JOIN USER on GUEST_ID = USER.ID;
