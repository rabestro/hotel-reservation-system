# suppress inspection "UnusedProperty" for whole file

#
# Find all available rooms of a certain type for a given period of time
#
Room.findAvailableRooms=\
    FROM Room rm \
    WHERE rm.type.id = :typeId \
    AND rm.id NOT IN ( \
        SELECT distinct r.room.id \
        FROM Reservation r \
        WHERE \
            r.room.type.id = :typeId \
        AND ( \
            r.checkIn <= :arrivalDate   AND r.checkOut >  :arrivalDate   OR \
            r.checkIn <  :departureDate AND r.checkOut >= :departureDate OR \
            r.checkIn <= :arrivalDate   AND r.checkOut >= :departureDate OR \
            r.checkIn >  :arrivalDate   AND r.checkOut <  :departureDate \
            ) \
    ) \
    ORDER BY rm.number ASC

#
# Calculate available rooms count by room types for a given period of time.
# Returns list of available room types with number of free rooms for the given period.
#
RoomType.getAvailability=\
  SELECT new lv.id.jc.hotel.model.dto.AvailabilityResponse(\
        types.id, \
        types.name, \
        count(rooms)) \
  FROM Room AS rooms \
  JOIN rooms.type AS types \
  WHERE rooms.id NOT IN (\
        SELECT distinct r.room.id \
        FROM Reservation r \
        WHERE \
            r.checkIn <= :arrivalDate   AND r.checkOut >  :arrivalDate   OR \
            r.checkIn <  :departureDate AND r.checkOut >= :departureDate OR \
            r.checkIn <= :arrivalDate   AND r.checkOut >= :departureDate OR \
            r.checkIn >  :arrivalDate   AND r.checkOut <  :departureDate \
        ) \
  GROUP BY types \
  ORDER BY types.id

